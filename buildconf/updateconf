#!/bin/sh

# find where this script lives
SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# where you have thumbslug checked out in relation to this script
TSDIR=`dirname $SCRIPTDIR`
TMPCONF='/tmp/ts.conf'
# thumbslug config
TSCONF='/etc/thumbslug/thumbslug.conf'

# whether we should actually write to the file or not
# defaults to 0. If the TSCONF does not exist OR if
# you pass in the force flag, -f, we will write to the file.
WRITE=0

# writes to the temporary file which will be copied to TSCONF
function write_to_tmpconf ()
{
    echo $1 >> $TMPCONF
}

function usage ()
{
    cat <<HELP
    usage: updateconf [options]

    OPTIONS:
        -f  overwrite thumbslug.conf
HELP
}

while getopts ":f" opt; do
    case $opt in
        f  ) WRITE="1" ;;
        ?  ) usage; exit;;
    esac
done

if [ ! -f $TSCONF ]; then
    sudo mkdir -p /etc/thumbslug
    sudo touch /etc/thumbslug/thumbslug.conf
    WRITE=1
fi

if [ "$WRITE" == "1" ]; then
    write_to_tmpconf "# generated by updateconf"
    write_to_tmpconf "candlepin.oauth.secret = thumbslug"
    write_to_tmpconf "ssl.keystore.password = password"
    write_to_tmpconf "log.access = $TSDIR/run/log/access.log"
    write_to_tmpconf "log.error = $TSDIR/run/log/error.log"
    write_to_tmpconf "pid.file = $TSDIR/run/thumbslug.pid"
    write_to_tmpconf "daemonize = false"
    write_to_tmpconf "log4j.logger.org.candlepin.thumbslug=DEBUG"
    write_to_tmpconf "cdn.ssl.ca.keystore=/etc/thumbslug/cdn-ca.pem"
    write_to_tmpconf "ssl=true"
    sudo mv $TMPCONF $TSCONF
fi

# copy the cdn over if not already present
if [ ! -f /etc/thumbslug/cdn-ca.pem ]; then
    sudo cp cdn-ca.pem /etc/thumbslug/
fi
sudo cp /etc/candlepin/certs/candlepin-ca.crt /etc/thumbslug/client-ca.pem
sudo cp /etc/candlepin/certs/keystore /etc/thumbslug/server_keystore.p12
